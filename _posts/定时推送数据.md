---
title: 定时推送数据
date: 
tags:
- shell
- hive
---

Add timed tasks for shell script to push data to a remote server.

<!--more-->

## 免密

要保证以下shell脚本可以正常工作，需保证脚本部署机器A对数据下发机器B免密，就需要将A机器上的公钥添加到B机器中的``authorized_keys``中。

## 推数脚本

```bash
#! /bin/bash
#系统时间 T+1
date1=`date -d " -1 day" +"%Y%m%d"`
#数据源服务器地址
init_server=1.1.1.1
#数据源数据库名
init_database=bgis
#数据源表名
init_table=bgis_mileage
#数据下发服务器地址
to_server=2.2.2.2
#数据下发服务器用户
to_user=dsadm
#数据下发路径头
to_path=/gpfscdc/input/maps
#数据下发文件头
to_filetop=maps
#数据下发文件名
to_filename=${to_filetop}_${init_table}_${date1}.del
#本地脚本存放路径
local_path=/bgis/script

#本地数据路径
rm -r -f $local_path/$init_database
mkdir -p $local_path/$init_database

#数据下发路径
ssh $to_user@$to_server "rm -r -f $to_path/$date1"
ssh $to_user@$to_server "mkdir -p $to_path/$date1"

#从数据源导出数据到HDFS
beeline -u jdbc:hive2://$init_server:10000/$init_database -e "insert overwrite directory '/tmp/$init_database/${init_table}_$date1' select * from $init_database.$init_table where datetime = $date1;"

#删除本地文件目录
rm -r -f $local_path/${init_table}_$date1

#下发文件从HDFS下载到本地
echo "hadoop fs -get /tmp/$init_database/${init_table}_$date1"
hadoop fs -get /tmp/$init_database/${init_table}_$date1 $local_path/

#重定向文件到本地目录
cat $local_path/${init_table}_$date1/* >> $local_path/$init_database/${init_table}_utf8.del

#必要时修改文件字符集
iconv -f utf8 -t gbk $local_path/$init_database/${init_table}_utf8.del > $local_path/$init_database/$init_table.del 

#下发数据文件到指定目录
echo "下发数据文件到指定目录"
scp $local_path/$init_database/$init_table.del $to_user@$to_server:$to_path/$date1/$to_filename

#下发文件大小
to_size=`ls -l $local_path/$init_database/$init_table.del|awk '{print $5}'`
#下发文件条数
to_num=`wc -l $local_path/$init_database/$init_table.del|awk '{print $1}'`

#下发flag文件
echo "$to_filename $to_size $to_num" > $local_path/$init_database/$to_filename.flg
echo "下发数据文件的flg到指定目录"
scp $local_path/$init_database/$to_filename.flg $to_user@$to_server:$to_path/$date1/

#删除本地文件数据
rm -r -f $local_path/${init_table}_${date1}
rm -r -f $local_path/$init_database

#检验下发文件目录中的.flg文件数量
echo "检验flg文件的数量"
flg_num=`ssh $to_user@$to_server "ls -lrt $to_path/$date1/*.flg"|wc -l`
echo "flg_num is $flg_num !!!!!!!"
#检验下发文件目录中的.del文件数量
echo "检验del文件的数量"
del_num=`ssh $to_user@$to_server "ls -lrt $to_path/$date1/*.del"|wc -l`
echo "del_num is $del_num !!!!!!!"

#判断flg文件和del文件个数是否相同
if [ $flg_num -eq $del_num ];then
    echo "全部文件下发完毕,success,exit 0"
        ssh $to_user@$to_server "echo "all is done!!!!!!!!" > $to_path/$date1/${to_filetop}_done"
        ssh $to_user@$to_server "cat $to_path/$date1/*.flg >> $to_path/$date1/${to_filetop}_done"
    exit 0
else
    echo "flg_num=$flg_num, del_num=$del_num, data is error, please contact manager, exit 1"
    ssh $to_user@to_server "rm -r -f $to_path/$date1"
    exit 1
fi
```

## 定时任务

```bash
crontab -e
#添加定时任务每天3点执行一次推数脚本
0 3 * * * /bgis/script/mileage.sh >> /bgis/script/mileage.log 2>&1
```




